name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: |
          echo "Repositório: ${{ github.repository }}"
          echo "Fazendo build..."
          npm run build
          echo ""
          echo "Build concluído! Verificando arquivos gerados:"
          ls -la dist/ || dir dist/
          echo ""
          echo "Verificando se index.html foi processado:"
          if grep -q "/src/main.jsx" dist/index.html 2>/dev/null || findstr "/src/main.jsx" dist\index.html >nul 2>&1; then
            echo "❌ ERRO: index.html não foi processado! Ainda contém /src/main.jsx"
            echo "Conteúdo do index.html:"
            cat dist/index.html
            exit 1
          else
            echo "✅ index.html foi processado corretamente!"
            echo "Primeiras linhas do index.html:"
            head -20 dist/index.html || type dist\index.html | more
          fi
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          # O base path será detectado automaticamente:
          # - User pages (username.github.io): base path = '/'
          # - Project pages (outros repositórios): base path = '/repo-name/'
          # Para customizar, defina VITE_BASE_PATH aqui
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
